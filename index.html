<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>unhosted social dashboard example</title>
  </head>
  <body>
    <h1>This app requires a Sockethub server.</h1>
    <div id="state"></div>
<!--      states:
- disconnected/failed [details]
- trying to connect
- connected [+twitter] [+facebook]
-->
    <p>
      <a href="http://sockethub.org/">Sockethub</a> server:
      <ul>
        <li>Domain and port: <input id="sockethubServer" value="localhost:10550" /></li>
        <li>Secret: <input id="sockethubSecret" value="1234567890" /></li>
      </ul>
      <input type="submit" value="connect" onclick="connect();" /> (you may have to click twice)
    </p>
    <p>
      <a href="https://dev.twitter.com/apps">Twitter</a> credentials:
      <input type="submit" value="save" onclick="getCredentials('twitter');" />
      <ul>
        <li>Consumer Key: <input id="twitterConsumerKey" /></li>
        <li>Consumer Secret: <input id="twitterConsumerSecret" /></li>
        <li>Access Token: <input id="twitterAccessToken" /></li>
        <li>Access Token Secret: <input id="twitterAccessTokenSecret" /></li>
      </ul>
    </p>
    <p>
      <a href="https://unhosted.org/adventures/5/Facebook-and-Twitter-from-nodejs.html">Facebook</a> credentials:
      <input type="submit" value="save" onclick="getCredentials('facebook');" />
      <ul>
        <li>Token: <input id="facebookToken" /></li>
      </ul>
    </p>
   <h1>Log:</h1>
   <ul id="log">
   </ul>
    <p>   
      Text: <input id="text" style="width:70em" /> 
      Target URL: <input id="targetUrl" value="/me/feed" />
      <input type="submit" value="f" onclick="sendTo('facebook');" style="background-color:#008;color:#fff" />
      <input type="submit" value="t" onclick="sendTo('twitter');" style="background-color:#bbf;color:#fff" />
   </p>
<!--
main panes:
- recipients
- write (first line is subject)
- forum-wide post button
- private message button -->
  </body>
  <script src="sockethub.js"></script>
  <script>
    function value(id, val) {
      if(val) {
        document.getElementById(id).value = val;
      }
      return document.getElementById(id).value;
    }
    function log(msg) {
      if(typeof(msg) != 'string') {
        msg = JSON.stringify(msg);
      }
      document.getElementById('log').innerHTML += '<li>'+msg+'</li>';
    }
    function getCredentials(platform) {
      var creds;
      if(platform == 'sockethub') {
        creds = {
          server: value('sockethubServer'),
          secret: value('sockethubSecret')
        };
      } else if(platform == 'facebook') {
        creds = {
          token: value('facebookToken')
        };
      } else {
        creds = {
          consumerKey: value('twitterConsumerKey'),
          consumerSecret: value('twitterConsumerSecret'),
          accessToken: value('twitterAccessToken'),
          accessTokenSecret: value('twitterAccessTokenSecret')
        };
      }
      localStorage.setItem(platform+'-credentials', JSON.stringify(creds));
      return creds;
    }
    function reviveCredentials(platform, cb) {
      var credsStr = localStorage.getItem(platform+'-credentials');
      if(typeof(credsStr) == 'string') {
        try {
          creds = JSON.parse(credsStr);
        } catch(e) {
          return;
        }
        if(platform == 'sockethub') {
          value('sockethubServer', creds.sockethubServer);
          value('sockethubSecret', creds.sockethubSecret);
        } else if(platform == 'facebook') {
          value('facebookToken', creds.token);
        } else {
          value('twitterConsumerKey', creds.consumerKey);
          value('twitterConsumerSecret', creds.consumerSecret);
          value('twitterAccessToken', creds.accessToken);
          value('twitterAccessTokenSecret', creds.accessTokenSecret);
        }
        if(cb) {
          cb();
        }
      }
    }
    function connect() {
      sockethub.connect(value('sockethubServer'), value('sockethubSecret'));
      sockethub.on('ready', function() {
        log('ready');
      });
      sockethub.on('error', log);
      sockethub.on('activity', log);
    }
    function sendTo(platform) {
      sockethub.post(platform, getCredentials(platform), {
        text: value('text')
      }, {
        url: value('targetUrl')
      });
    }
    log('Ready for you to click "Connect"');
    reviveCredentials('sockethub', connect);
    reviveCredentials('twitter');
    reviveCredentials('facebook');
  </script>
</html>
